<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insulin Rechner v17</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            padding: 20px;
            margin: 0;
            padding-bottom: 60px;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px; 
        }
        .section-title {
            margin-top: 25px;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
            color: #555;
            font-weight: bold;
            font-size: 1rem;
        }
        button {
            width: 100%;
            background-color: #007bff;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            margin-top: 25px;
            cursor: pointer;
        }
        button:active { background-color: #0056b3; }
        
        /* Ergebnis Bereich Styles */
        #result {
            margin-top: 25px;
            padding: 20px;
            background-color: #f0f7ff;
            border: 1px solid #cce5ff;
            border-radius: 12px;
            display: none;
        }
        .result-small {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }
        .iob-alert {
            font-size: 0.8rem;
            color: #d35400;
            text-align: right;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .trend-info {
            font-size: 0.8rem;
            color: #888;
            text-align: right;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        /* Hauptzahlen */
        .result-big-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid #dae0e5;
        }
        .label-main { font-weight: bold; font-size: 1.1rem; }
        .val-main { font-weight: 800; font-size: 1.4rem; }
        
        .color-blue { color: #007bff; }
        .color-orange { color: #d35400; }

        /* Timing Box unten */
        .info-box {
            background-color: #fff;
            border: 1px solid #e2e6ea;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }
        .info-line {
            margin-bottom: 5px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }
        .info-label { font-weight: bold; color: #555; }
        
        .warning {
            font-size: 0.7rem;
            color: #999;
            text-align: center;
            margin-top: 20px;
        }
        
        .license-footer {
            font-size: 0.7rem;
            color: #bbb;
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
            line-height: 1.4;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Insulin Rechner</h2>

    <div class="section-title">Essen</div>
    <label>Kohlenhydrate (g)</label>
    <input type="number" id="kh" placeholder="0">

    <label>Eiwei√ü (g)</label>
    <input type="number" id="ew" placeholder="0">

    <label>Fett (g)</label>
    <input type="number" id="fett" placeholder="0">

    <div class="section-title">Aktiver Bolus (IOB)</div>
    <label>Letzte Injektion (IE)</label>
    <input type="number" id="last_bolus" placeholder="0">
    
    <label>Vor wie vielen Stunden?</label>
    <input type="number" id="last_time" placeholder="z.B. 1.5">

    <div class="section-title">Blutzucker (mg/dl)</div>
    <label>Aktueller BZ</label>
    <input type="number" id="bz_aktuell" placeholder="120">

    <label>Trend Delta (letzte 15 Min)</label>
    <input type="number" id="bz_trend" placeholder="+10 oder -5">

    <div class="section-title">Einstellungen</div>
    <label>Ziel BZ</label>
    <input type="number" id="bz_ziel" value="120">

    <label>ICR (g KH pro Einheit)</label>
    <input type="number" id="icr" value="33">

    <label>ISF (mg/dl pro Einheit)</label>
    <input type="number" id="isf" value="60">

    <label>Wirkdauer Insulin (Std.)</label>
    <input type="number" id="wirkdauer" value="4">

    <label>Insulin Typ</label>
    <select id="insulin_typ">
        <option value="rapid">Schnellwirksam (Fiasp, Lyumjev)</option>
        <option value="normal">Normal (NovoRapid, Humalog)</option>
        <option value="regular">Alt-Insulin (Actrapid)</option>
    </select>

    <button onclick="berechne()">Berechnen</button>

    <div id="result">
        <div class="result-small"><span>Anteil KH:</span> <span id="res_kh">0.0 IE</span></div>
        <div class="result-small"><span>Anteil Korrektur (Brutto):</span> <span id="res_korr_raw">0.0 IE</span></div>
        <div class="iob-alert" id="iob_display" style="display:none;">- Aktives IOB: <span id="res_iob">0.0</span> IE</div>
        <div class="result-small"><span>Anteil FPE:</span> <span id="res_fpe_small">0.0 IE</span></div>
        
        <div class="trend-info" id="trend_note"></div>

        <div class="result-big-row color-blue">
            <span class="label-main">Sofort Bolus:</span>
            <span class="val-main" id="res_total">0.0 IE</span>
        </div>

        <div class="result-big-row color-orange">
            <span class="label-main">FPE Bolus:</span>
            <span class="val-main" id="res_fpe_insulin">0.0 IE</span>
        </div>

        <div class="info-box">
            <div class="info-line">
                <span class="info-label">üïí Injektion:</span>
                <span id="res_timing_text">-</span>
            </div>
            <div class="info-line">
                <span class="info-label">‚è≥ FPE Dauer:</span>
                <span>
                    <span id="res_fpe_time">-</span> 
                    <span style="font-size:0.75rem; color:#999;">(<span id="res_fpe_count">0</span> FPE)</span>
                </span>
            </div>
        </div>
    </div>

    <p class="warning">KEIN MEDIZINPRODUKT.</p>
    
    <div class="license-footer">
        App by <strong>Stefan Zuegg</strong> ‚Ä¢ 2025<br>
        Lizenz: CC BY-NC-SA 4.0
    </div>

</div>

<script>
    function berechne() {
        // --- WERTE HOLEN ---
        let kh = parseFloat(document.getElementById('kh').value) || 0;
        let ew = parseFloat(document.getElementById('ew').value) || 0;
        let fett = parseFloat(document.getElementById('fett').value) || 0;
        
        let lastBolus = parseFloat(document.getElementById('last_bolus').value) || 0;
        let lastTime = parseFloat(document.getElementById('last_time').value) || 0;
        
        let icr = parseFloat(document.getElementById('icr').value);
        let isf = parseFloat(document.getElementById('isf').value);
        let wirkdauer = parseFloat(document.getElementById('wirkdauer').value) || 4;
        
        let bzInput = document.getElementById('bz_aktuell').value;
        let bz_aktuell = parseFloat(bzInput) || 0;
        let bz_trend = parseFloat(document.getElementById('bz_trend').value) || 0;
        let bz_ziel = parseFloat(document.getElementById('bz_ziel').value) || 120;
        let typ = document.getElementById('insulin_typ').value;

        if (!icr || !isf) {
            alert("Bitte ICR und ISF eingeben!");
            return;
        }

        // --- 1. IOB BERECHNUNG (Lineare Abnahme) ---
        let iob = 0;
        if (lastBolus > 0 && lastTime < wirkdauer) {
            // Anteil der noch √ºbrig ist
            let remainingTime = wirkdauer - lastTime;
            iob = lastBolus * (remainingTime / wirkdauer);
        }
        if (iob < 0) iob = 0;


        // --- 2. INSULIN BEDARF ---

        // A) Essen
        let insulinKh = kh / icr;

        // B) Korrektur (mit Trend)
        let insulinKorrRaw = 0; // Brutto Korrektur
        let insulinKorrNet = 0; // Netto (nach IOB Abzug)
        let prognoseBz = bz_aktuell; 

        if (bzInput !== "") {
            prognoseBz = bz_aktuell + (bz_trend * 2);
            // Rohe Korrektur berechnen
            insulinKorrRaw = (prognoseBz - bz_ziel) / isf;
